!function(e,t,n,i){tinymce.create("tinymce.plugins.xen_tagging",{init:function(t){var n=xenMCE.Lib.getTools();if(n.getParam("oldXen"))return!1;this.editor=t;var i=this;t.on("PastePreProcess",function(e){e.content=e.content.replace(/(.|^)<a\s[^>]*data-user="(\d+, [^"]+)"[^>]*>([\w\W]+?)<\/a>/gi,function(e,t,n){var i=n.split(", ");return parseInt(i[0],10)?t+("@"==t?"":"@")+i[1].replace(/^@/,""):e})}),t.on("init",function(){var n=e(t.getElement()),r=e(t.getBody()),o=n.data("ac-url")||XenForo.AutoComplete.getDefaultUrl();i.$textarea=n,i.$ed=r,i.autoCompleteUrl=o;var s=r.get(0).ownerDocument,a=function(){setTimeout(function(){i.acResults.hideResults()},200)};i.acVisible=!1,i.acResults=new XenForo.AutoCompleteResults({onInsert:e.proxy(i,"insert")}),e(s.defaultView||s.parentWindow).on("scroll",a),r.on("click blur",a),t.on("keydown",function(e){var t=i.acResults,n=!0;if(t.isVisible()){switch(e.keyCode){case 40:t.selectResult(1);break;case 38:t.selectResult(-1);break;case 27:t.hideResults();break;case 13:t.insertSelectedResult();break;default:n=!1}n&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault())}}),t.on("keyup",function(){var e=i.getAfterAt();e?i.trigger(e):i.hide()})})},getAfterAt:function(){return this.parseCurrentLine()},insert:function(t){if(!this.range)return void console.alert("Range is missing");var n,r,o=this.editor,s=(o.selection.getEnd(),this.range),a=s.endContainer;if(1==a.nodeType&&tinymce.isIE&&tinymce.Env.ie<=9)n=e(a).contents().filter(function(){return 3==this.nodeType}).text();else{if(3!=a.nodeType)return!1;n=a.nodeValue}if(typeof n===i)return!1;r=n.lastIndexOf("@"),s.setStart(a,r),o.selection.setRng(this.range);var l="@"+XenForo.htmlspecialchars(t)+"&nbsp;";return o.execCommand("mceInsertContent",!1,l),o.nodeChanged(),this.lastAcLookup=t+" ",!1},trigger:function(t){t=t.replace(new RegExp(String.fromCharCode(160),"g")," "),this.lastAcLookup&&this.lastAcLookup==t||(this.hide(),this.lastAcLookup=t,t.length>2&&"["!=t.substr(0,1)&&(this.acLoadTimer=setTimeout(e.proxy(this,"lookup"),200)))},lookup:function(){this.acXhr&&this.acXhr.abort(),this.acXhr=XenForo.ajax(this.autoCompleteUrl,{q:this.lastAcLookup},e.proxy(this,"showResults"),{global:!1,error:!1})},showResults:function(t){this.acXhr=!1,this.bookmark=!1;var n=this.editor;$iframe=e(n.getContainer()).find("iframe"),$iframeBody=e(n.getBody());var r=n.selection.getBookmark();$bm=$iframeBody.find("#"+r.id+"_start");var o=function(){$bm.remove()},s=$bm.parent().get(0),a=$bm.get(0),l=$bm.get(0).previousSibling;if(typeof l===i||null===l)return o(),!1;var u=l.nodeValue;if(typeof u===i||null===u)return o(),!1;var c=u.lastIndexOf("@");if(-1==c)return o(),!1;var f=l.splitText(c);s.insertBefore(a,f);var h=$iframe.offset(),d=$bm.offset(),g={top:h.top+d.top+$bm.parent().height(),left:h.left+d.left};o(),this.acResults.showResults(this.lastAcLookup,t.results,$iframe,g)},hide:function(){this.acResults.hideResults(),this.acLoadTimer&&(clearTimeout(this.acLoadTimer),this.acLoadTimer=!1)},parseCurrentLine:function(){this.range=!1;{var e,t,n,r=this.editor,o=r.selection.getRng(!0).cloneRange(),s=o.endContainer;o.endContainer.previousSibling}return 3!=s.nodeType?!1:(e=s.nodeValue,typeof e===i?!1:(t=e.lastIndexOf("@"),-1==t||0!=t&&!e.substr(t-1,1).match(/(\s|[\](,]|--)/)?!1:(n=e.substr(t+1),n.match(/\s/)||n.length>10||n.length<2?!1:(this.range=o,n))))}}),tinymce.PluginManager.add("xen_tagging",tinymce.plugins.xen_tagging)}(jQuery,this,document,"undefined");